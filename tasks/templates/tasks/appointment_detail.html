{% extends 'base.html' %}
{% block title %}Appointments list{% endblock title %}
{% block scripts %}
<script>
    // define variables to reference them in different functions
    let map;
    let markerFrom;
    let markerTo;
    let directionsService;
    let directionsRenderer;
  
    // main function
    function initMap() {
        // create map and render put it on page
        // default start coordinates are set to Nazarbayev University
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 51.089888409978656, lng: 71.40146902770996 },
            zoom: 15, // camera zoom
        });
        
        // initialize direction services from Google Maps API and connect to map
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
        });

        // set maps default coordinates to form fields to ensure that they are not empty
        document.getElementById("latitudeTo").value = map.getCenter().lat();
        document.getElementById("longitudeTo").value = map.getCenter().lng();
        document.getElementById("latitudeFrom").value = map.getCenter().lat();
        document.getElementById("longitudeFrom").value = map.getCenter().lng();

        // 2 markers for departure and arrival points
        markerFrom = new google.maps.Marker({
            position: map.getCenter(), 
            map: map,
            draggable: true,
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: "red",
                fillOpacity: 0.7,
                strokeColor: "blue",
                strokeWeight: 1,
                scale: 10,
                labelOrigin: new google.maps.Point(0, 2)
            },
            label: {
                text: "Departure",
                color: "blue",
                fontWeight: "bold",
                labelOrigin: new google.maps.Point(0, 10)
            },
        });
  
        markerTo = new google.maps.Marker({
            position: map.getCenter(),
            map: map,
            draggable: true,
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: "blue",
                fillOpacity: 0.7,
                strokeColor: "blue",
                strokeWeight: 1,
                scale: 10,
                labelOrigin: new google.maps.Point(0, 2)
            },
            label: {
                text: "Arrival",
                color: "blue",
                fontWeight: "bold",
            },
        });

        // when markers positions are changed we change coordinates in corresponding form fields
        google.maps.event.addListener(markerFrom, "dragend", function () {
            document.getElementById("latitudeFrom").value = markerFrom.getPosition().lat();
            document.getElementById("longitudeFrom").value = markerFrom.getPosition().lng();
        });

        google.maps.event.addListener(markerTo, "dragend", function () {
            document.getElementById("latitudeTo").value = markerTo.getPosition().lat();
            document.getElementById("longitudeTo").value = markerTo.getPosition().lng();
            calculateAndDisplayRoute()
        });

        // add Google API's autocomplete to help to search for locations in search input fields
        // 2 fields for departure and arrival inputs 
        const inputFrom = document.getElementById("searchInputFrom");
        const inputTo = document.getElementById("searchInputTo");
        const autocompleteFrom = new google.maps.places.Autocomplete(inputFrom);
        const autocompleteTo = new google.maps.places.Autocomplete(inputTo);
        
        // when place is selected by search bar using autocomplete, we update map and corresponding marker
        autocompleteFrom.addListener("place_changed", () => {
            const place = autocompleteFrom.getPlace(); // get selected place
            // process error
            if (!place.geometry) {
                console.error("Returned place contains no geometry");
                return;
            }
            // center map on selected place
            map.setCenter(place.geometry.location);
            // set marker to that place
            markerFrom.setPosition(place.geometry.location);
            // update form fields
            document.getElementById("latitudeFrom").value = place.geometry.location.lat();
            document.getElementById("longitudeFrom").value = place.geometry.location.lng();
        });
        // same procedure for arrival point
        autocompleteTo.addListener("place_changed", () => {
            const place = autocompleteTo.getPlace();
            if (!place.geometry) {
            console.error("Returned place contains no geometry");
            return;
            }
    
            map.setCenter(place.geometry.location);
            markerTo.setPosition(place.geometry.location);
            document.getElementById("latitudeTo").value = place.geometry.location.lat();
            document.getElementById("longitudeTo").value = place.geometry.location.lng();

            calculateAndDisplayRoute();
        });
    }
  
    // function to calculate and display Route
    function calculateAndDisplayRoute() {
        // get two points using our markers
        const start = markerFrom.getPosition();
        const end = markerTo.getPosition();
        // generate route using Google service
        directionsService.route({
                origin: start,
                destination: end,
                travelMode: google.maps.TravelMode.DRIVING,
            },
            (response, status) => {
                // process result
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsRenderer.setDirections(response);
                } else {
                    window.alert("Directions request failed due to " + status);
                }
            }
        );
      }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBiEgnwnW0STa5XZcpJ0ErLq4DkUxiSPnk&libraries=places&callback=initMap" async defer></script>
{% endblock scripts %}

{% block styles %}
<style>
    #map {
      height: 400px;
      width: 100%;
    }
  </style>
{% endblock styles %}

{% block content %}

<div class="row justify-content-between mb-5">
    <div class="col-5">
        <h3>Create Task</h3>
        <hr>
        <div class="card shadow">
            <div class="card-body">
                <h5>Appointment details</h5>
                
                <div class="row">
                    <div class="col-sm-4">
                        <span>Description</span>
                    </div>
                    <div class="col-sm-8">
                        {{appointment.description}}
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-4">
                        <span>Driver</span>
                    </div>
                    <div class="col-sm-8">
                        {{appointment.driver}}
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-4">
                        <span>Preffered car type</span>
                    </div>
                    <div class="col-sm-8">
                        {{appointment.car_type}}
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-4">
                        <span>Date</span>
                    </div>
                    <div class="col-sm-8">
                        {{appointment.date}}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-7">
        {% if cars %}
        <form method="POST">
            {% csrf_token %}
            <div class="mb-3">
                <label for="id_car" class="form-label">Select vehicle:</label>
                <select name="car" class="form-control" required="" id="id_car">
                    <option value="" selected="">---------</option>
                    {% for car in cars %}
                    <option value="{{car.id}}">{{car}}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="row">
                <div class="col" >
                    <div class="row mb-3">
                        <div class="col">
                            <span>Specify departure location</span>
                            <input type="text" id="searchInputFrom" class="form-control" placeholder="Search for a location" >
        
                        </div>
                        <div class="col">
                            <span>Specify arrival location</span>
                            <input type="text" id="searchInputTo" class="form-control" placeholder="Search for a location" >
                        </div>
                        </div>
                    <div class="col">
                        <div id="map" class="mb-3"></div>
                    </div>
                    <div class="col d-none">
                        <span>Departure point</span>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label for="latitudeFrom" class="form-label">Latitude:</label>
                                <input type="text" id="latitudeFrom" name="latitudeFrom" class="form-control" readonly>
                            </div>
                            <div class="col-6">
                                <label for="longitudeFrom" class="form-label">Longitude:</label>
                                <input type="text" id="longitudeFrom" name="longitudeFrom" class="form-control" readonly>
                            </div>
                        </div>
                    </div>
                   
                    <div class="col d-none">
                        <span>Arrival point</span>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label for="latitudeTo" class="form-label">Latitude:</label>
                                <input type="text" id="latitudeTo" name="latitudeTo" class="form-control" readonly>
                            </div>
                            <div class="col-6">
                                <label for="longitudeTo" class="form-label">Longitude:</label>
                                <input type="text" id="longitudeTo" name="longitudeTo" class="form-control" readonly>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
            </div>
            <button style="width: 100%;" type="submit" class="btn btn-primary">Add</button>
        </form>
        {% else %}
        <div class="alert alert-danger" role="alert">
            There are no available cars at the moment! <br>
            Complete other tasks or add more vehicles...
        </div>
        {% endif %}
    </div>
</div>

{% endblock content %}
<h1 class="mb-4">Map Point Selector</h1>
